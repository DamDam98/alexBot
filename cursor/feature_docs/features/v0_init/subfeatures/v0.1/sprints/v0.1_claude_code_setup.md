# Sprint: v0.1 Claude Code SDK Setup

## Overview

Initial integration of Claude Code SDK into alexbot Express.js backend. Goal is to replace the current echo functionality with actual Claude responses using the simplest possible integration.

## Sprint Goals

- Get Claude Code SDK working end-to-end
- Replace echo endpoint with real Claude responses
- Establish basic error handling and monitoring
- Lay foundation for future MCP integration

## Step-by-Step Plan

### **Step 1: Create Sanity Check Endpoint**

- Add a simple `GET /health` or `GET /ping` endpoint that returns basic status
- This gives us a way to verify the server is running without any external dependencies
- **Goal**: Have a reliable endpoint we can always hit to verify the server is alive
- **Deliverable**: Working `/health` endpoint

### **Step 2: Install Claude Code SDK Package**

- Run `npm install @anthropic-ai/claude-code`
- Update package.json dependencies
- **Goal**: Get the package installed and ready to import
- **Deliverable**: Package installed, no import errors

### **Step 3: Set Up ANTHROPIC_API_KEY**

- Create/update `.env` file with the API key
- Add environment variable handling to the app
- Test that we can read the API key properly
- **Goal**: Have authentication working for Claude API calls
- **Deliverable**: API key properly configured and readable

### **Step 4: Replace Chat Endpoint with Minimal Claude Code SDK Call**

- Replace the current echo functionality in the chat endpoint
- Make the simplest possible Claude Code SDK call (no MCP, no special config)
- Return the Claude response instead of echoing the request
- **Goal**: Get one working Claude Code response end-to-end
- **Deliverable**: `/chat` endpoint returns actual Claude responses

### **Step 5: Add GitHub MCP Integration**

- Add GitHub MCP server for repository access
- Configure read-only permissions scoped to senseilyapp organization
- Enable code search, issue lookup, and PR awareness capabilities
- **Goal**: Enable alexbot to answer questions with live GitHub data
- **Deliverable**: Chat endpoint can answer questions about senseilyapp repositories

## Next Sprint Goals (Future)

- **Step 6**: Implement dev mode vs plain language mode
- **Step 7**: Add session management
- **Step 8**: Slack integration preparation

## Success Criteria

- [x] Health endpoint responds correctly
- [x] Claude Code SDK installed without errors
- [x] API key configured and accessible
- [x] Chat endpoint returns Claude responses instead of echo
- [x] Basic error handling in place
- [x] Can make test requests successfully
- [‚ùå] GitHub MCP integration working
- [‚ùå] Can answer questions about senseilyapp repositories
- [‚ùå] Read-only security model verified

## Notes

- Keep it simple - no MCP configuration in this sprint
- Focus on getting the basic plumbing working
- Add logging to help with debugging
- Maintain the existing Docker setup

## Step 4 Detailed Plan - Generations

### **Pre-Step 4: Verify Current State**

Before proceeding, test what we think should be happening:

- [x] `npm run dev` is running locally
- [x] Health endpoint works: `curl http://localhost:3000/health`
- [x] Chat endpoint echoes: `curl -X POST http://localhost:3000/chat -H "Content-Type: application/json" -d '{"message": "test"}'`
- [x] Console shows: "Claude Code SDK imported successfully: true"
- [x] Console should show: "API key loaded: true" (after Generation 1)

### **Generation 1: Environment & Testing Setup**

- Add dotenv import and config
- Add API key verification logging
- Create a simple test function to verify Claude Code SDK works
- **Goal**: Confirm environment is set up and Claude SDK can be called
- **Test**: Console logs show API key loaded, test function works

### **Generation 2: Replace the Endpoint Logic**

- Replace the echo logic with actual Claude Code SDK call
- Add basic error handling (try/catch)
- **Goal**: Get the core functionality working - endpoint returns Claude responses
- **Test**: `curl` to `/chat` returns Claude response instead of echo

### **Generation 3: Polish & Final Testing**

- Clean up response format (structured JSON with metadata)
- Test multiple scenarios and edge cases
- **Goal**: Make it production-ready and verify everything works
- **Test**: Multiple different requests work consistently

### **Testing Philosophy**

- **Verify assumptions** before making changes
- **Test each generation** independently
- **Append-only documentation** to maintain progression history
- **Small, focused changes** with clear test criteria

---

## ‚úÖ Step 4 Complete Summary

**Completed Successfully (Generation 1-3):**

- ‚úÖ Environment setup with dotenv and API key configuration
- ‚úÖ Modern async/await implementation with express-async-handler
- ‚úÖ Clean, production-ready code (59 lines, TypeScript compatible)
- ‚úÖ Centralized error handling middleware
- ‚úÖ Working endpoints: `/health` and `/chat`
- ‚úÖ Full end-to-end testing verified

**Next:** Step 5 - GitHub MCP Integration

---

## ‚ùå Step 5: GitHub MCP Integration - BLOCKED & CLEANED UP

### **Critical Discovery: Claude Code SDK MCP Integration Issues**

**Research conducted on MCP integration with extensive debugging methodology resulted in definitive root cause identification.**

### **What We Discovered:**

#### **‚úÖ What Works Perfectly:**

- **MCP Protocol**: Tested with MCP Inspector - perfect functionality
- **MCP Servers**: Filesystem server and GitHub servers work independently
- **Claude Code CLI**: MCP integration works perfectly via command line
- **Configuration Files**: All JSON configs parse correctly
- **Environment Setup**: All environment variables properly configured

#### **‚ùå What's Broken:**

- **Claude Code TypeScript SDK MCP Integration**: Multiple confirmed bugs
- **SDK Internal Process**: Crashes with exit code 143 (SIGTERM) when `mcpConfig` is used
- **Server Loading**: `üì° MCP servers status: []` (always empty array)

### **Evidence Gathered:**

#### **1. Official Bug Reports Found:**

- **GitHub Issue #2682**: "MCP Tools Not Available Despite Successful Connection" - exact match
- **GitHub Issue #2652**: "Global Claude Code settings override SDK client configuration"
- **Multiple open issues**: MCP area labeled bugs in Claude Code repository

#### **2. Working CLI vs Broken SDK:**

```bash
# ‚úÖ This works perfectly
claude -p "List files in current directory" \
  --mcp-config mcp-config.json \
  --allowedTools "mcp__filesystem__list_directory"

# ‚ùå This crashes: SDK with mcpConfig option
query({ options: { mcpConfig: "./mcp-config.json" } })
```

#### **3. Systematic Testing Conducted:**

- **Config file detection**: ‚úÖ Files found and parsed correctly
- **SDK basic functionality**: ‚úÖ Works without MCP
- **MCP server manual testing**: ‚úÖ Perfect with MCP Inspector
- **SDK MCP integration**: ‚ùå Process crashes every time

### **Root Cause Analysis:**

**The Claude Code TypeScript SDK has confirmed bugs in MCP integration that cause:**

1. Internal process crashes when `mcpConfig` is specified
2. MCP servers fail to initialize even when config is valid
3. SDK does not properly bridge to the CLI's working MCP functionality

### **Alternative Solutions Investigated:**

#### **Option A: Direct GitHub API Integration** ‚≠ê **(Recommended for MVP)**

- Use GitHub REST API directly with existing token
- Implement specific endpoints needed (file reading, issue search, etc.)
- Faster time to market, reliable, well-documented
- Can add MCP later when SDK bugs are fixed

#### **Option B: CLI Integration via Child Process**

- Spawn Claude CLI from Node.js application
- Pass queries through CLI with working MCP integration
- More complex but leverages working MCP functionality

#### **Option C: Wait for SDK Bug Fixes**

- Monitor Claude Code repository for MCP fixes
- Current bugs are open and acknowledged by Anthropic team
- Timeline unknown for resolution

### **Security Implementation (Completed):**

Despite MCP integration issues, security infrastructure was successfully implemented:

#### **‚úÖ GitHub Token Setup Completed:**

- Fine-grained Personal Access Token created
- Scoped to `senseilyapp` organization only
- Read-only permissions: Contents, Issues, Pull requests, Metadata
- Token stored securely in `.env` file as `GITHUB_TOKEN`
- Comprehensive security testing conducted and documented

#### **‚úÖ Security Validation Passed:**

- Token scope limitations verified
- Organization boundary enforcement confirmed
- Read-only operations tested
- SOPs created for setup, testing, and security validation

### **üßπ Cleanup Performed:**

#### **Files Removed:**

- ‚ùå `mcp-config.json` - MCP configuration file (integration doesn't work)
- ‚ùå `test-*.js` files - Temporary debugging scripts
- ‚ùå Debug logging - Excessive console output removed

#### **Code Cleaned:**

- ‚úÖ `src/index.ts` - Clean, production-ready version
- ‚úÖ Removed all MCP references and configuration
- ‚úÖ Removed debug logging and excessive console output
- ‚úÖ Simplified Claude API calls to working functionality only

### **Current Project State:**

#### **‚úÖ Successfully Completed:**

- Express.js server with TypeScript
- Health endpoint functionality
- Chat endpoint with Claude Code SDK (without MCP)
- Environment variable configuration
- GitHub token setup and security validation
- Comprehensive debugging and root cause analysis
- **Clean codebase ready for next development**

#### **üö´ Blocked Items (Removed from Current Scope):**

- GitHub MCP integration (SDK bugs)
- Live repository data access via MCP
- Code search capabilities via MCP
- Issue/PR awareness features via MCP

---

## üìã **HANDOFF NOTES - Next Development Session**

### **Current Clean State:**

- ‚úÖ **Production-ready codebase**: `src/index.ts` cleaned of all MCP and debug code
- ‚úÖ **Working functionality**: Health and chat endpoints functional
- ‚úÖ **No broken dependencies**: All MCP-related files removed
- ‚úÖ **Environment configured**: API keys and tokens ready
- ‚úÖ **Docker setup intact**: Containerization still available

### **Immediate Next Steps (Choose One Path):**

#### **Path A: GitHub API Direct Integration** ‚≠ê **(Recommended)**

**Goal**: Get GitHub integration working quickly while MCP SDK bugs are resolved

**Implementation Plan**:

1. **Install GitHub API client**: `npm install @octokit/rest`
2. **Create GitHub service module** (`src/services/github.ts`):
   - File content reading
   - Repository listing
   - Issue/PR searching
   - Code search functionality
3. **Update Claude prompts** to reference GitHub data retrieved via API
4. **Implement specific endpoints** needed for senseilyapp repositories

**Advantages**:

- ‚úÖ Will definitely work (no SDK dependency issues)
- ‚úÖ Fast implementation (1-2 sessions)
- ‚úÖ Reliable and well-documented APIs
- ‚úÖ Can migrate to MCP later when bugs are fixed

**Time Estimate**: 4-6 hours

#### **Path B: Enhanced Chat Features**

**Goal**: Improve the basic chat functionality while waiting for MCP solutions

**Implementation Plan**:

1. **Add conversation context**: Session management for multi-turn conversations
2. **Implement response modes**: Technical vs plain language responses
3. **Add response formatting**: Better structure for technical responses
4. **Create specialized prompts**: Different prompts for different use cases

**Time Estimate**: 2-3 hours

#### **Path C: Monitor SDK Fixes**

**Goal**: Wait for official MCP bug fixes in Claude Code SDK

**Implementation Plan**:

1. **Set up monitoring** of Claude Code repository issues
2. **Test new SDK versions** as they're released
3. **Implement MCP integration** once bugs are resolved

**Advantages**:

- ‚úÖ Uses intended architecture (MCP)
- ‚úÖ Cleaner integration when working
- ‚úÖ Full tool ecosystem benefits

**Disadvantages**:

- ‚ùå Timeline unknown
- ‚ùå No guarantees bugs will be fixed quickly
- ‚ùå Blocks forward progress

### **Development Environment State:**

#### **‚úÖ Ready to Use:**

- Node.js/TypeScript setup working
- Claude Code SDK functioning (without MCP)
- Environment variables configured
- GitHub token authenticated and scoped
- Docker environment available
- **Clean, debugged codebase**

#### **üìÇ Key Files:**

- `src/index.ts`: Clean production-ready code (no MCP references)
- `.env`: Contains `ANTHROPIC_API_KEY` and `GITHUB_TOKEN`
- `package.json`: All dependencies installed
- `sop/`: GitHub token setup and testing procedures

### **Architecture Decisions Made:**

1. **Claude Code SDK**: Keep using for Claude API calls (works perfectly)
2. **MCP Integration**: Removed due to SDK bugs - clean slate for next approach
3. **GitHub Integration**: Recommend direct API approach for MVP
4. **Security Model**: Fine-grained read-only token confirmed working

### **Questions for Next Session:**

1. **Path Selection**: Which integration path do you prefer (direct API vs enhanced chat vs wait for MCP fixes)?
2. **Scope Refinement**: Which GitHub features are most critical for first implementation?
3. **Timeline Preferences**: MVP fast (direct API) vs feature enhancement vs architectural purity?

### **Time Investment Summary:**

**Total Time Invested**: ~6 hours of focused debugging and integration work
**Key Learnings**:

- MCP protocol works perfectly, SDK integration does not
- Systematic debugging methodology pays off for complex integration issues
- Having multiple solution paths prevents blocking on single dependencies
- Clean up and documentation are critical for effective handoffs

**Next Session Prep**:

- Choose integration path
- Have GitHub requirements prioritized
- Be ready to implement GitHub API directly if choosing Path A

---

**üéØ Bottom Line**: Claude Code SDK works great for basic functionality. MCP integration is buggy and has been cleaned up. Recommend direct GitHub API integration to unblock progress while monitoring for SDK fixes. Codebase is now clean and ready for next development phase.
